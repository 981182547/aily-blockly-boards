# 开发板配置规范 

## 开发板配置库结构
aily blockly库基本遵循google blockly库结构，使用npm包管理形式管理库的版本及相关必要信息。一个aily blockly库的结构如下：
```
board_name  
 |- board.json             // 开发板配置文件
 |- board.webp             // 开发板图片
 |- package.json           // npm包管理文件
 |- example                // 示例程序文件夹
    |- <示例程序列表>
 |- template               // 初始模板文件夹
    |- package.json
    |- project.abi
```

## board-name.json
这里提供一个Arduino UNO的做参考：
```json
{
    "name": "Arduino UNO",
    "version":"1.0.0",
    "description": "Arduino UNO standard compatible board",
    "compilerTool": "arduino-cli",
    "core": "aily:avr@1.8.5",
    "type": "aily:avr:uno",
    "compilerParam": "compile -v -b aily:avr:uno",
    "uploadParam": "upload -v -b aily:avr:uno -p ${serial}",
    "analogPins": [
        ["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
    ],
    "digitalPins": [
        ["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"],["13","13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
    ],
    "pwmPins": [
        ["3","3"],["5","5"],["6","6"],["9","9"],["10","10"],["11","11"]
    ],
    "serialPort": [
        ["Serial","Serial"]
    ],
    "serialSpeed": [
        ["1200","1200"],["9600","9600"],["14400","14400"],["19200","19200"],["38400","38400"],["57600","57600"],["115200","115200"]
    ],
    "spi": [
        ["SPI","SPI"]
    ],
    "spiPins": {
        "SPI": [
            ["MOSI",11],["MISO",12],["SCK",13]
        ]
    },
    "spiClockDivide": [
        ["2 (8MHz)","SPI_CLOCK_DIV2"],["4 (4MHz)","SPI_CLOCK_DIV4"],["8 (2MHz)","SPI_CLOCK_DIV8"],["16 (1MHz)","SPI_CLOCK_DIV16"],["32 (500KHz)","SPI_CLOCK_DIV32"],["64 (250KHz)","SPI_CLOCK_DIV64"],["128 (125KHz)","SPI_CLOCK_DIV128"]
    ],
    "i2c": [
        ["I2C","Wire"]
    ],
    "i2cPins": {
        "Wire": [
            ["SDA","A4"],["SCL","A5"]
        ]
    },
    "i2cSpeed": [
        ["100kHz","100000L"],["400kHz","400000L"]
    ],
    "builtinLed": [
        ["BUILTIN_LED","13"]
    ],
    "interruptPins": [
        ["2","2"],["3","3"]
    ],
    "interruptMode": [
        ["LOW","LOW"],["RISING","RISING"],["FALLING","FALLING"],["CHANGE","CHANGE"]
    ]
}
```

### 编译上传配置
```json
    "compilerTool": "arduino-cli",  // 使用的编译工具，目前是arduino-cli，不需要更改
    "core": "arduino:avr@1.8.5",    // 开发板核心及对应版本号
    "type": "arduino:avr:uno",      // 开发板类型
    "compilerParam": "compile -v -b arduino:avr:uno",  //编译参数
    "uploadParam": "upload -v -b arduino:avr:uno -p ${serial}",  //上传参数，其中${serial}是串口变量，实际使用时会替换成用户选择的串口
```

#### 可用配置
 ${serial} 为用户选择的设备串口  
 ${mac} 为无线下载时用户选择的设备，可蓝牙，可wifi  
 ${usb} 为usb下载时用户选择的设备  

#### arduino-cli参考
当前配置参考自arduino cli配置，可见[arduino-cli文档](https://arduino.github.io/arduino-cli)  

你可能使用到的命令：
```bash
arduino-cli core list // 列出已安装的核心
arduino-cli board search // 列出可用的开发板
```

### 引脚等配置
```json
"digitalPins": [
    ["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"],["11","11"],["12","12"],["13","13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]
]
```
这些配置是用于block加载时调用的，在对应位置添加${board.varName}即可，在库文件的block.json中使用方式如下：
```json
[
  {
    "inputsInline": true,
    "message0": "数字引脚%1",
    "type": "io_pin_digi",
    "colour": "#00C48C",
    "args0": [
      {
        "type": "field_dropdown",
        "name": "PIN",
        "options": "${board.digitalPins}"
      }
    ],
    "output": "Any"
  }
]
```
在库加载时，对应位置的`${board.digitalPins}`会自动替换成`board.json`中的`digitalPins`配置。  

## package.json
基本遵循npm包管理规范，需注意的是其中`boardDependencies`项包含了开发板编译、上传等动作要用到的依赖，针对不同内核的参考依赖如下：
```json
// AVR内核，如Arduino UNO\MEGA\LEONARDO等开发板
{
    "@aily-project/compiler-avr-gcc": "7.3.0",
    "@aily-project/tool-avrdude": "6.3.0",
    "@aily-project/sdk-avr": "1.8.6",
    "@aily-project/tool-ctags": "5.8.0"
}
```  
```json
// Renesas RA4M1内核，如Arduino UNO R4系列
{
    "@aily-project/compiler-arm-none-eabi-gcc": "7.2.1",
    "@aily-project/tool-bossac": "1.9.1",
    "@aily-project/sdk-renesas_uno": "1.3.2",
    "@aily-project/tool-ctags": "5.8.0",
    "@aily-project/tool-dfu-util": "0.11.0"    
}
```
```json
// ESP32内核
{
    "@aily-project/compiler-esp-x32": "14.2.0",
    "@aily-project/tool-esptool_py": "4.8.1",
    "@aily-project/sdk-esp32": "3.2.0",
    "@aily-project/tool-idf_esp32": "5.4.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```
```json
// ESP32C3内核
{
    "@aily-project/compiler-esp-rv32": "14.2.0",
    "@aily-project/tool-esptool_py": "4.8.1",
    "@aily-project/sdk-esp32": "3.2.0",
    "@aily-project/tool-idf_esp32c3": "5.4.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```
```json
// ESP32S3内核
{
    "@aily-project/compiler-esp-x32": "14.2.0",
    "@aily-project/tool-esptool_py": "4.8.1",
    "@aily-project/sdk-esp32": "3.2.0",
    "@aily-project/tool-idf_esp32s3": "5.4.0",
    "@aily-project/tool-ctags": "5.8.0"
}
```
```json
// ESP32C6内核 待更新
```
```json
// ESP32H2内核 待更新
```
```json
// ESP32S2内核 待更新
```
```json
// ESP32P4内核 待更新
```
```json
// RP2040，如树莓派Pico 待更新
```
```json
// RP2350，如树莓派Pico2  待更新
```
```json
// SAM3X，如Arduino Due 待更新
```

## 初始项目模板（template）
每个开发板包中，带有一个`template`目录，其中存放的是新建项目后加载的模板项目。
可以修改`template\package.json`，添加默认加载的库，如[Grove Beginner Kit的package.json](grove_beginner_kit\template\package.json)
```json
{
  "name": "project_",
  "version": "1.0.0",
  "description": "",
  "dependencies": {
    "@aily-project/board-grove_beginner_kit": "^1.0.0",
    "@aily-project/lib-core-io": "1.0.0",
    "@aily-project/lib-core-logic": "0.0.1",
    "@aily-project/lib-core-loop": "0.0.1",
    "@aily-project/lib-core-math": "0.0.1",
    "@aily-project/lib-core-text": "0.0.1",
    "@aily-project/lib-core-serial": "0.0.1",
    "@aily-project/lib-core-time": "0.0.1",
    "@aily-project/lib-core-variables": "1.0.1",
    "@aily-project/lib-dht": "1.0.0",
    "@aily-project/lib-bmp280": "0.0.1",
    "@aily-project/lib-u8g2": "1.0.0",
    "@aily-project/lib-core-tone": "0.0.1",
    "@aily-project/lib-lis3dhtr": "0.0.1"
  }
}
```

`template\project.abi`为对应的blockly工作区文件，默认的project.abi通常如下：
```json
{
  "blocks": {
    "languageVersion": 0,
    "blocks": [
      {
        "type": "arduino_setup",
        "id": "arduino_setup_id0",
        "x": 30,
        "y": 30,
        "deletable": false 
      },
      {
        "type": "arduino_loop",
        "id": "arduino_loop_id0",
        "x": 30,
        "y": 290,
        "deletable": false 
      }
    ]
  }
}
```
你也可以把预先编辑好的项目写入其中，用户使用该开发板后新建项目后，即会自动加载上此程序。